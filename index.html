<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento - Barbearia Pedro's</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <script>
        // Configuração do Firebase (mesma da ferramenta de gestão)
        const firebaseConfig = {
            apiKey: "AIzaSyD3ScwfW4Ld2WV6QCntph6HdvhT3xztZzU",
            authDomain: "barbearia-a66e9.firebaseapp.com",
            projectId: "barbearia-a66e9",
            storageBucket: "barbearia-a66e9.firebasestorage.app",
            messagingSenderId: "30136159716",
            appId: "1:30136159716:web:05770f391df96196464bf1"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #000000 0%, #333333 100%);
        }
        
        .premium-gradient {
            background: linear-gradient(135deg, #333333 0%, #666666 100%);
        }
        
        .service-card, .barber-card, .plan-card {
            transition: all 0.3s ease;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        .service-card:hover, .barber-card:hover, .plan-card:hover,
        .service-card:active, .barber-card:active, .plan-card:active {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .service-card.selected, .barber-card.selected, .plan-card.selected {
            border-color: #333333;
            background: linear-gradient(135deg, #33333310, #66666610);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .plan-card.premium.selected {
            border-color: #666666;
            background: linear-gradient(135deg, #33333310, #66666610);
        }
        
        .time-slot {
            transition: all 0.3s ease;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .time-slot:hover, .time-slot:active {
            background: #33333320;
            transform: scale(1.02);
        }
        
        .time-slot.selected {
            background: linear-gradient(135deg, #333333, #666666);
            color: white;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .time-slot.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f3f4f6;
        }
        
        .step-indicator {
            transition: all 0.3s ease;
        }
        
        .step-indicator.active {
            background: linear-gradient(135deg, #333333, #666666);
            color: white;
        }
        
        .step-indicator.completed {
            background: #10b981;
            color: white;
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        
        .slide-up {
            animation: slideUp 1s ease-out 0.5s both;
        }
        
        .elegant-entrance {
            animation: elegantEntrance 1.2s ease-out 1.5s both;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes elegantEntrance {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeOut 0.8s ease-out 3s both;
        }
        
        @keyframes fadeOut {
            to { opacity: 0; visibility: hidden; }
        }
        
        .welcome-text {
            color: white;
            font-size: 2.5rem;
            font-weight: 300;
            text-align: center;
            letter-spacing: 2px;
            animation: welcomeAnimation 2.5s ease-out;
            padding: 0 1rem;
        }
        
        @keyframes welcomeAnimation {
            0% { opacity: 0; transform: translateY(30px); }
            40% { opacity: 1; transform: translateY(0); }
            60% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        
        .premium-badge {
            background: linear-gradient(45deg, #333333, #666666);
            color: white;
            font-weight: bold;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .loading-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .welcome-text {
                font-size: 1.8rem;
                line-height: 1.3;
            }
            
            .service-card, .barber-card, .plan-card {
                padding: 1.5rem 1rem;
                margin-bottom: 0.5rem;
            }
            
            .time-slot {
                min-height: 52px;
                font-size: 1rem;
                font-weight: 600;
            }
            
            .step-indicator {
                width: 2.5rem;
                height: 2.5rem;
                font-size: 0.9rem;
            }
            
            .premium-badge {
                top: 0.5rem;
                right: 0.5rem;
                font-size: 0.7rem;
                padding: 3px 8px;
            }
        }
        
        @media (max-width: 640px) {
            .service-card h3, .barber-card h3 {
                font-size: 1.1rem;
            }
            
            .service-price {
                font-size: 1.3rem;
            }
            
            .time-slot {
                font-size: 0.95rem;
                min-height: 50px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Screen -->
    <div class="loading-screen">
        <div class="welcome-text">
            Seja bem-vindo ao App da<br>Barbearia Pedro's
        </div>
    </div>
    
    <!-- Header -->
    <div class="gradient-bg text-white py-6 md:py-8">
        <div class="max-w-4xl mx-auto px-4">
            <div class="text-center">
                <h1 class="text-2xl md:text-3xl font-bold mb-2">✂️ Barbearia Pedro's</h1>
                <p class="text-base md:text-lg opacity-90">Agende seu horário de forma rápida e fácil</p>
            </div>
        </div>
    </div>

    <!-- Progress Steps -->
    <div class="max-w-4xl mx-auto px-4 py-4 md:py-6 hidden">
        <div class="flex justify-center items-center space-x-1 md:space-x-2 mb-6 md:mb-8">
            <div class="step-indicator active flex items-center justify-center w-8 h-8 md:w-10 md:h-10 rounded-full bg-gray-300 text-gray-600 font-semibold text-sm md:text-base">1</div>
            <div class="w-6 md:w-12 h-1 bg-gray-300"></div>
            <div id="step2" class="step-indicator flex items-center justify-center w-8 h-8 md:w-10 md:h-10 rounded-full bg-gray-300 text-gray-600 font-semibold text-sm md:text-base">2</div>
            <div class="w-6 md:w-12 h-1 bg-gray-300"></div>
            <div id="step3" class="step-indicator flex items-center justify-center w-8 h-8 md:w-10 md:h-10 rounded-full bg-gray-300 text-gray-600 font-semibold text-sm md:text-base">3</div>
            <div class="w-6 md:w-12 h-1 bg-gray-300"></div>
            <div id="step4" class="step-indicator flex items-center justify-center w-8 h-8 md:w-10 md:h-10 rounded-full bg-gray-300 text-gray-600 font-semibold text-sm md:text-base">4</div>
            <div class="w-6 md:w-12 h-1 bg-gray-300"></div>
            <div id="step5" class="step-indicator flex items-center justify-center w-8 h-8 md:w-10 md:h-10 rounded-full bg-gray-300 text-gray-600 font-semibold text-sm md:text-base">5</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 pb-8">
        
        <!-- Tela de Boas-vindas -->
        <div id="welcomeScreen" class="elegant-entrance" style="opacity: 0;">
            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-6 text-center">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-3 md:mb-4 slide-up" style="opacity: 0;">Para melhor atendê-lo</h2>
                <h1 class="text-2xl md:text-4xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent mb-6 slide-up" style="opacity: 0;">Selecione uma das opções abaixo</h1>
                
                <div class="grid gap-4 md:grid-cols-2 md:gap-6 max-w-2xl mx-auto slide-up" style="opacity: 0;">
                    <!-- Plano Premium -->
                    <div class="plan-card premium border-2 border-gray-400 rounded-xl p-6 md:p-8 relative overflow-hidden" data-plan="premium">
                        <div class="absolute top-2 right-2 md:top-0 md:right-0 premium-badge">PREMIUM</div>
                        <div class="premium-gradient w-16 h-16 md:w-20 md:h-20 rounded-full flex items-center justify-center mx-auto mb-4 md:mb-6">
                            <div class="w-6 h-6 md:w-8 md:h-8 bg-white rounded-full"></div>
                        </div>
                        <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-3 md:mb-4">Sou Cliente Frequente</h3>
                        <p class="text-gray-600 text-base md:text-lg">Já sou cliente da barbearia</p>
                    </div>
                    
                    <!-- Agendamento Avulso -->
                    <div class="plan-card border-2 border-gray-300 rounded-xl p-6 md:p-8" data-plan="avulso">
                        <div class="bg-gradient-to-r from-gray-600 to-gray-800 w-16 h-16 md:w-20 md:h-20 rounded-full flex items-center justify-center mx-auto mb-4 md:mb-6">
                            <div class="w-6 h-6 md:w-8 md:h-8 bg-white rounded-full"></div>
                        </div>
                        <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-3 md:mb-4">Primeira Vez</h3>
                        <p class="text-gray-600 text-base md:text-lg">Novo cliente da barbearia</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Verificação Premium -->
        <div id="premiumVerification" class="bg-white rounded-xl shadow-lg p-6 mb-6 hidden fade-in">
            <div class="text-center">
                <div class="premium-gradient w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                    <span class="text-4xl">👋</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Que bom te ver novamente!</h2>
                <p class="text-gray-600 mb-6">Digite seu telefone para acessarmos seu histórico</p>
                
                <div class="max-w-md mx-auto">
                    <input type="tel" id="premiumPhone" class="w-full p-4 border-2 border-gray-400 rounded-lg text-lg focus:border-gray-500 focus:outline-none text-center" placeholder="18 99999-9999">
                    <button id="verifyPremium" class="w-full mt-4 premium-gradient text-white px-6 py-3 rounded-lg font-semibold transition-all hover:shadow-lg">
                        <span id="verifyText">Buscar Meus Dados</span>
                        <div id="verifyLoading" class="loading-indicator hidden"></div>
                    </button>
                </div>
                
                <div id="premiumNotFound" class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-700 hidden">
                    <p class="font-semibold">📱 Telefone não encontrado</p>
                    <p class="text-sm">Não encontramos este número em nossos registros. Deseja continuar como novo cliente?</p>
                    <button id="switchToAvulso" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                        Continuar como Novo Cliente
                    </button>
                </div>
            </div>
        </div>

        <!-- Confirmação Premium -->
        <div id="premiumWelcome" class="bg-gradient-to-r from-gray-700 to-gray-900 text-white rounded-xl shadow-lg p-6 mb-6 hidden fade-in">
            <div class="text-center">
                <div class="text-4xl mb-4">🎉</div>
                <h2 class="text-2xl font-bold mb-2">Bem-vindo de volta!</h2>
                <p class="text-lg opacity-90 mb-4">Olá <span id="premiumClientName" class="font-bold">Cliente</span></p>
                <div class="bg-white bg-opacity-20 rounded-lg p-4 mb-4">
                    <p class="text-sm"><strong>Encontramos seu histórico:</strong></p>
                    <p class="text-sm" id="clientHistory">✅ Cliente desde [data] • ✅ [X] agendamentos realizados</p>
                </div>
                <p class="text-sm opacity-90">Continue para agendar seu próximo atendimento</p>
            </div>
        </div>

        <!-- Step 1: Serviços -->
        <div id="servicesStep" class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-6 hidden">
            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6 text-center">Escolha seu serviço</h2>
            <div id="servicesContainer" class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
                <!-- Serviços serão carregados do Firebase -->
                <div class="text-center py-8">
                    <div class="loading-indicator mx-auto mb-4"></div>
                    <p class="text-gray-600">Carregando serviços...</p>
                </div>
            </div>
        </div>

        <!-- Step 2: Barbeiros -->
        <div id="barbersStep" class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-6 hidden">
            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6 text-center">Escolha seu barbeiro</h2>
            <div id="barbersContainer" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-3 gap-3 md:gap-4">
                <!-- Barbeiros serão carregados do Firebase -->
                <div class="text-center py-8">
                    <div class="loading-indicator mx-auto mb-4"></div>
                    <p class="text-gray-600">Carregando barbeiros...</p>
                </div>
            </div>
        </div>

        <!-- Step 3: Data -->
        <div id="dateStep" class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-6 hidden">
            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6 text-center">Escolha a data</h2>
            <div class="max-w-md mx-auto">
                <input type="date" id="dateInput" class="w-full p-3 md:p-4 border-2 border-gray-300 rounded-lg text-base md:text-lg focus:border-purple-500 focus:outline-none">
            </div>
        </div>

        <!-- Step 4: Horário -->
        <div id="timeStep" class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-6 hidden">
            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6 text-center">Escolha o horário</h2>
            <div id="timeSlots" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 md:gap-3">
                <!-- Horários serão gerados dinamicamente -->
            </div>
        </div>

        <!-- Step 5: Dados do Cliente -->
        <div id="clientStep" class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-6 hidden">
            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4 md:mb-6 text-center">Seus dados</h2>
            <div class="max-w-md mx-auto space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome completo</label>
                    <input type="text" id="clientName" class="w-full p-3 md:p-4 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none text-base" placeholder="Digite seu nome">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">WhatsApp</label>
                    <input type="tel" id="clientPhone" class="w-full p-3 md:p-4 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none text-base" placeholder="18 99999-9999">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações (opcional)</label>
                    <textarea id="clientNotes" class="w-full p-3 md:p-4 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none text-base" rows="3" placeholder="Alguma observação especial?"></textarea>
                </div>
            </div>
        </div>

        <!-- Resumo do Agendamento -->
        <div id="summaryCard" class="bg-gradient-to-r from-gray-700 to-gray-900 text-white rounded-xl shadow-lg p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4">📋 Resumo do Agendamento</h3>
            <div class="space-y-2">
                <p><span class="font-semibold">Serviço:</span> <span id="summaryService">-</span></p>
                <p><span class="font-semibold">Barbeiro:</span> <span id="summaryBarber">-</span></p>
                <p><span class="font-semibold">Data:</span> <span id="summaryDate">-</span></p>
                <p><span class="font-semibold">Horário:</span> <span id="summaryTime">-</span></p>
                <p id="summaryPriceRow"><span class="font-semibold">Valor:</span> <span id="summaryPrice">-</span></p>
            </div>
        </div>

        <!-- Botões de Navegação -->
        <div class="flex justify-between items-center gap-3">
            <button id="prevBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 md:px-6 py-3 rounded-lg font-semibold transition-colors hidden text-sm md:text-base">
                ← Voltar
            </button>
            <button id="nextBtn" class="bg-gradient-to-r from-gray-800 to-gray-600 hover:from-gray-900 hover:to-gray-700 text-white px-6 md:px-8 py-3 rounded-lg font-semibold transition-all ml-auto text-sm md:text-base">
                Continuar →
            </button>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
            <div class="text-center">
                <div class="text-6xl mb-4">✅</div>
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Agendamento Confirmado!</h3>
                <p class="text-gray-600 mb-6">Seu horário foi agendado com sucesso. Você receberá uma confirmação no WhatsApp.</p>
                <div class="bg-gray-50 rounded-lg p-4 mb-6 text-left">
                    <p class="text-sm text-gray-600 mb-2"><strong>Detalhes do agendamento:</strong></p>
                    <p class="text-sm"><strong>Serviço:</strong> <span id="confirmService">-</span></p>
                    <p class="text-sm"><strong>Barbeiro:</strong> <span id="confirmBarber">-</span></p>
                    <p class="text-sm"><strong>Data:</strong> <span id="confirmDate">-</span></p>
                    <p class="text-sm"><strong>Horário:</strong> <span id="confirmTime">-</span></p>
                    <p class="text-sm"><strong>Valor:</strong> <span id="confirmPrice">-</span></p>
                </div>
                <button onclick="closeModal()" class="bg-gradient-to-r from-gray-800 to-gray-600 hover:from-gray-900 hover:to-gray-700 text-white px-8 py-3 rounded-lg font-semibold transition-all w-full">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 0;
        let selectedPlan = null;
        let selectedService = null;
        let selectedBarber = null;
        let selectedDate = null;
        let selectedTime = null;
        let isPremiumClient = false;
        let premiumClientData = null;
        let servicesData = [];
        let barbersData = [];

        // Horários disponíveis (podem ser configurados no sistema de gestão)
        const availableSlots = [
            '08:00', '08:30', '09:00', '09:30', '10:00', '10:30',
            '11:00', '11:30', '13:00', '13:30', '14:00', '14:30',
            '15:00', '15:30', '16:00', '16:30', '17:00', '17:30'
        ];

        // Configurar data mínima (hoje)
        document.getElementById('dateInput').min = new Date().toISOString().split('T')[0];

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            setupWelcomeScreen();
            setupPremiumVerification();
            setupDateSelection();
            setupNavigation();
            loadInitialData();
        });

        async function loadInitialData() {
            try {
                // Carregar dados da estrutura existente (appointments)
                const appointmentsSnapshot = await db.collection('appointments').get();
                
                // Extrair serviços únicos dos agendamentos existentes
                const servicesSet = new Set();
                const barbersSet = new Set();
                
                appointmentsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.service) {
                        servicesSet.add(JSON.stringify({
                            name: data.service,
                            price: data.price || 50,
                            serviceType: data.serviceType || 'geral'
                        }));
                    }
                    if (data.barber) {
                        barbersSet.add(JSON.stringify({
                            name: data.barber,
                            specialty: 'Barbeiro profissional'
                        }));
                    }
                });

                // Converter para arrays
                servicesData = Array.from(servicesSet).map((item, index) => ({
                    id: `service_${index}`,
                    ...JSON.parse(item)
                }));

                barbersData = Array.from(barbersSet).map((item, index) => ({
                    id: `barber_${index}`,
                    ...JSON.parse(item)
                }));

                // Se não houver dados, usar fallback
                if (servicesData.length === 0 || barbersData.length === 0) {
                    loadFallbackData();
                }

                console.log('Dados carregados da estrutura existente:', { servicesData, barbersData });
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                loadFallbackData();
            }
        }

        function loadFallbackData() {
            // Dados de fallback baseados na estrutura que você mostrou
            servicesData = [
                { id: '1', name: 'Pacote Só Barba', price: 25, serviceType: 'barba' },
                { id: '2', name: 'Corte + Barba', price: 40, serviceType: 'completo' },
                { id: '3', name: 'Corte Simples', price: 30, serviceType: 'corte' },
                { id: '4', name: 'Corte Premium', price: 50, serviceType: 'premium' },
                { id: '5', name: 'Sobrancelha', price: 15, serviceType: 'sobrancelha' },
                { id: '6', name: 'Relaxamento', price: 35, serviceType: 'tratamento' }
            ];

            barbersData = [
                { id: '1', name: 'barbeiro1', specialty: 'Especialista em cortes clássicos' },
                { id: '2', name: 'João Santos', specialty: 'Expert em barbas e bigodes' },
                { id: '3', name: 'Pedro Lima', specialty: 'Cortes modernos e degradês' },
                { id: '4', name: 'Rafael Costa', specialty: 'Especialista em relaxamento' }
            ];
        }

        function setupWelcomeScreen() {
            const planCards = document.querySelectorAll('.plan-card');
            
            planCards.forEach(card => {
                card.addEventListener('click', function() {
                    planCards.forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedPlan = this.dataset.plan;
                    
                    setTimeout(() => {
                        if (selectedPlan === 'premium') {
                            showPremiumVerification();
                        } else {
                            isPremiumClient = false;
                            startBookingFlow();
                        }
                    }, 500);
                });
            });
        }

        function setupPremiumVerification() {
            const verifyButton = document.getElementById('verifyPremium');
            const phoneInput = document.getElementById('premiumPhone');
            const switchButton = document.getElementById('switchToAvulso');
            
            verifyButton.addEventListener('click', async function() {
                const phone = phoneInput.value.trim();
                if (!phone) {
                    alert('Por favor, digite seu telefone');
                    return;
                }
                
                // Mostrar loading
                document.getElementById('verifyText').classList.add('hidden');
                document.getElementById('verifyLoading').classList.remove('hidden');
                verifyButton.disabled = true;
                
                try {
                    const premiumClient = await findPremiumClient(phone);
                    
                    if (premiumClient) {
                        isPremiumClient = true;
                        premiumClientData = premiumClient;
                        showPremiumWelcome(premiumClient);
                    } else {
                        document.getElementById('premiumNotFound').classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Erro ao verificar cliente premium:', error);
                    alert('Erro ao verificar dados. Tente novamente.');
                } finally {
                    // Esconder loading
                    document.getElementById('verifyText').classList.remove('hidden');
                    document.getElementById('verifyLoading').classList.add('hidden');
                    verifyButton.disabled = false;
                }
            });
            
            switchButton.addEventListener('click', function() {
                isPremiumClient = false;
                selectedPlan = 'avulso';
                startBookingFlow();
            });
            
            // Máscara para telefone premium
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length <= 11) {
                    value = value.replace(/^(\d{2})(\d)/g, '$1 $2');
                    value = value.replace(/(\d)(\d{4})$/, '$1-$2');
                }
                e.target.value = value;
            });
        }

        async function findPremiumClient(phone) {
            try {
                // Buscar na coleção appointments existente usando a estrutura atual
                const cleanPhone = phone.replace(/\D/g, '');
                const appointmentsSnapshot = await db.collection('appointments').get();
                
                let clientData = null;
                let appointmentCount = 0;
                
                appointmentsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const docPhone = data.phone ? data.phone.replace(/\D/g, '') : '';
                    
                    if (docPhone === cleanPhone) {
                        appointmentCount++;
                        if (!clientData) {
                            clientData = {
                                id: doc.id,
                                name: data.name,
                                phone: data.phone
                            };
                        }
                    }
                });
                
                // Se encontrou o cliente e tem pelo menos 1 agendamento, considerar como cliente frequente
                if (clientData && appointmentCount > 0) {
                    return {
                        ...clientData,
                        isPremium: true,
                        appointmentCount: appointmentCount
                    };
                }
                
                return null;
            } catch (error) {
                console.error('Erro ao buscar cliente:', error);
                return null;
            }
        }

        function showPremiumVerification() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('premiumVerification').classList.remove('hidden');
            document.getElementById('prevBtn').classList.remove('hidden');
        }

        function showPremiumWelcome(client) {
            document.getElementById('premiumVerification').classList.add('hidden');
            document.getElementById('premiumWelcome').classList.remove('hidden');
            document.getElementById('premiumClientName').textContent = client.name;
            
            // Mostrar histórico do cliente
            const historyText = `✅ Cliente da casa • ✅ ${client.appointmentCount} agendamento(s) realizados`;
            document.getElementById('clientHistory').textContent = historyText;
            
            setTimeout(() => {
                startBookingFlow();
            }, 3000);
        }

        function startBookingFlow() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('premiumVerification').classList.add('hidden');
            document.getElementById('premiumWelcome').classList.add('hidden');
            
            currentStep = 1;
            
            const progressContainer = document.querySelector('.max-w-4xl.mx-auto.px-4.py-4');
            if (progressContainer) {
                progressContainer.classList.remove('hidden');
            }
            
            document.getElementById('prevBtn').classList.remove('hidden');
            document.getElementById('nextBtn').textContent = 'Continuar →';
            
            loadServices();
            loadBarbers();
            updateStepDisplay();
        }

        function loadServices() {
            const container = document.getElementById('servicesContainer');
            container.innerHTML = '';
            
            servicesData.forEach(service => {
                const serviceCard = document.createElement('div');
                serviceCard.className = 'service-card border-2 border-gray-200 rounded-lg p-4';
                serviceCard.dataset.service = service.name;
                serviceCard.dataset.price = service.price;
                serviceCard.dataset.id = service.id;
                serviceCard.dataset.serviceType = service.serviceType || 'geral';
                
                serviceCard.innerHTML = `
                    <div class="text-center">
                        <h3 class="font-semibold text-lg mb-2">${service.name}</h3>
                        <p class="service-price text-xl font-bold text-gray-800">R$ ${service.price.toFixed(2)}</p>
                    </div>
                `;
                
                serviceCard.addEventListener('click', function() {
                    document.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    selectedService = {
                        id: service.id,
                        name: service.name,
                        price: service.price,
                        serviceType: service.serviceType || 'geral'
                    };
                    
                    updateSummary();
                    document.getElementById('nextBtn').disabled = false;
                });
                
                container.appendChild(serviceCard);
            });
        }

        function loadBarbers() {
            const container = document.getElementById('barbersContainer');
            container.innerHTML = '';
            
            barbersData.forEach(barber => {
                const barberCard = document.createElement('div');
                barberCard.className = 'barber-card border-2 border-gray-200 rounded-lg p-3 md:p-4';
                barberCard.dataset.barber = barber.name;
                barberCard.dataset.specialty = barber.specialty;
                barberCard.dataset.id = barber.id;
                
                const initials = barber.name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                barberCard.innerHTML = `
                    <div class="text-center">
                        <div class="w-12 h-12 md:w-16 md:h-16 bg-gradient-to-r from-gray-800 to-gray-600 rounded-full flex items-center justify-center text-white text-lg md:text-2xl font-bold mx-auto mb-2 md:mb-3">${initials}</div>
                        <h3 class="font-semibold text-sm md:text-lg">${barber.name}</h3>
                    </div>
                `;
                
                barberCard.addEventListener('click', function() {
                    document.querySelectorAll('.barber-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    selectedBarber = {
                        id: barber.id,
                        name: barber.name,
                        specialty: barber.specialty
                    };
                    
                    updateSummary();
                    document.getElementById('nextBtn').disabled = false;
                });
                
                container.appendChild(barberCard);
            });
        }

        function setupDateSelection() {
            document.getElementById('dateInput').addEventListener('change', function() {
                selectedDate = this.value;
                generateTimeSlots();
                updateSummary();
            });
        }

        async function generateTimeSlots() {
            const timeSlotsContainer = document.getElementById('timeSlots');
            timeSlotsContainer.innerHTML = '<div class="col-span-full text-center"><div class="loading-indicator mx-auto mb-2"></div><p class="text-gray-600">Carregando horários...</p></div>';
            
            try {
                const occupiedSlots = await getOccupiedSlots(selectedDate, selectedBarber.name);
                timeSlotsContainer.innerHTML = '';
                
                availableSlots.forEach(slot => {
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot border-2 border-gray-300 rounded-lg p-3 text-center font-semibold';
                    timeSlot.textContent = slot;
                    
                    if (occupiedSlots.includes(slot)) {
                        timeSlot.classList.add('unavailable');
                        timeSlot.textContent += ' (Ocupado)';
                    } else {
                        timeSlot.addEventListener('click', function() {
                            document.querySelectorAll('.time-slot').forEach(t => t.classList.remove('selected'));
                            this.classList.add('selected');
                            selectedTime = slot;
                            updateSummary();
                        });
                    }
                    
                    timeSlotsContainer.appendChild(timeSlot);
                });
            } catch (error) {
                console.error('Erro ao carregar horários:', error);
                timeSlotsContainer.innerHTML = '<div class="col-span-full text-center text-red-600">Erro ao carregar horários. Tente novamente.</div>';
            }
        }

        async function getOccupiedSlots(date, barberName) {
            try {
                const snapshot = await db.collection('appointments')
                    .where('date', '==', date)
                    .where('barber', '==', barberName)
                    .get();
                
                return snapshot.docs.map(doc => {
                    const data = doc.data();
                    // Assumindo que pode ter campo 'time' ou extrair do horário
                    return data.time || ''; 
                }).filter(time => time);
            } catch (error) {
                console.error('Erro ao buscar horários ocupados:', error);
                return [];
            }
        }

        function setupNavigation() {
            document.getElementById('nextBtn').addEventListener('click', nextStep);
            document.getElementById('prevBtn').addEventListener('click', prevStep);
        }

        function nextStep() {
            if (currentStep === 1 && !selectedService) {
                alert('Por favor, selecione um serviço');
                return;
            }
            
            if (currentStep === 2 && !selectedBarber) {
                alert('Por favor, selecione um barbeiro');
                return;
            }
            
            if (currentStep === 3 && !selectedDate) {
                alert('Por favor, selecione uma data');
                return;
            }
            
            if (currentStep === 4 && !selectedTime) {
                alert('Por favor, selecione um horário');
                return;
            }
            
            if (currentStep === 5) {
                let name, phone;
                
                if (isPremiumClient) {
                    name = premiumClientData.name;
                    phone = premiumClientData.phone;
                } else {
                    name = document.getElementById('clientName').value.trim();
                    phone = document.getElementById('clientPhone').value.trim();
                    
                    if (!name || !phone) {
                        alert('Por favor, preencha nome e telefone');
                        return;
                    }
                }
                
                confirmAppointment();
                return;
            }
            
            currentStep++;
            updateStepDisplay();
        }

        function prevStep() {
            if (document.getElementById('premiumVerification').classList.contains('hidden') === false) {
                returnToPlanSelection();
                return;
            }
            
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            } else if (currentStep === 1) {
                returnToPlanSelection();
            }
        }

        function returnToPlanSelection() {
            document.querySelectorAll('[id$="Step"]').forEach(step => step.classList.add('hidden'));
            document.getElementById('summaryCard').classList.add('hidden');
            const progressContainer = document.querySelector('.max-w-4xl.mx-auto.px-4.py-4');
            if (progressContainer) {
                progressContainer.classList.add('hidden');
            }
            document.getElementById('premiumVerification').classList.add('hidden');
            document.getElementById('premiumWelcome').classList.add('hidden');
            
            currentStep = 0;
            selectedPlan = null;
            selectedService = null;
            selectedBarber = null;
            selectedDate = null;
            selectedTime = null;
            isPremiumClient = false;
            premiumClientData = null;
            
            document.querySelectorAll('.plan-card').forEach(card => card.classList.remove('selected'));
            document.querySelectorAll('.service-card').forEach(card => card.classList.remove('selected'));
            document.querySelectorAll('.barber-card').forEach(card => card.classList.remove('selected'));
            document.querySelectorAll('.time-slot').forEach(slot => slot.classList.remove('selected'));
            
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('prevBtn').classList.add('hidden');
            
            document.getElementById('dateInput').value = '';
            document.getElementById('clientName').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientNotes').value = '';
            document.getElementById('premiumPhone').value = '';
            document.getElementById('premiumNotFound').classList.add('hidden');
        }

        function updateStepDisplay() {
            document.querySelectorAll('[id$="Step"]').forEach(step => step.classList.add('hidden'));
            
            const steps = ['servicesStep', 'barbersStep', 'dateStep', 'timeStep', 'clientStep'];
            document.getElementById(steps[currentStep - 1]).classList.remove('hidden');
            
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                indicator.classList.remove('active', 'completed');
                if (index + 1 < currentStep) {
                    indicator.classList.add('completed');
                } else if (index + 1 === currentStep) {
                    indicator.classList.add('active');
                }
            });
            
            document.getElementById('prevBtn').classList.remove('hidden');
            document.getElementById('nextBtn').textContent = currentStep === 5 ? 'Confirmar Agendamento' : 'Continuar →';
            
            document.getElementById('summaryCard').classList.toggle('hidden', currentStep === 1);
            
            // Pré-preencher dados se for cliente premium
            if (currentStep === 5 && isPremiumClient) {
                document.getElementById('clientName').value = premiumClientData.name;
                document.getElementById('clientPhone').value = premiumClientData.phone;
                document.getElementById('clientName').disabled = true;
                document.getElementById('clientPhone').disabled = true;
            }
        }

        function updateSummary() {
            if (selectedService) {
                document.getElementById('summaryService').textContent = selectedService.name;
                document.getElementById('summaryPrice').textContent = `R$ ${selectedService.price.toFixed(2)}`;
            }
            
            if (selectedBarber) {
                document.getElementById('summaryBarber').textContent = selectedBarber.name;
            }
            
            if (selectedDate) {
                const date = new Date(selectedDate + 'T00:00:00');
                document.getElementById('summaryDate').textContent = date.toLocaleDateString('pt-BR');
            }
            
            if (selectedTime) {
                document.getElementById('summaryTime').textContent = selectedTime;
            }
        }

        async function confirmAppointment() {
            let clientName, clientPhone, notes;
            
            if (isPremiumClient) {
                clientName = premiumClientData.name;
                clientPhone = premiumClientData.phone;
                notes = document.getElementById('clientNotes').value.trim() || 'Cliente frequente - Agendamento via app';
            } else {
                clientName = document.getElementById('clientName').value.trim();
                clientPhone = document.getElementById('clientPhone').value.trim();
                notes = document.getElementById('clientNotes').value.trim();
            }
            
            // Usar a mesma estrutura da ferramenta de gestão
            const appointmentData = {
                name: clientName,
                phone: clientPhone,
                service: selectedService.name,
                serviceType: selectedService.serviceType,
                barber: selectedBarber.name,
                date: selectedDate,
                time: selectedTime,
                price: selectedService.price,
                notes: notes,
                status: 'agendado',
                isFrequentClient: isPremiumClient,
                createdAt: new Date().toISOString(),
                source: 'app_agendamento'
            };
            
            try {
                // Salvar na mesma coleção da ferramenta de gestão
                await db.collection('appointments').add(appointmentData);
                
                // Mostrar modal de confirmação
                document.getElementById('confirmService').textContent = appointmentData.service;
                document.getElementById('confirmBarber').textContent = appointmentData.barber;
                document.getElementById('confirmDate').textContent = new Date(appointmentData.date + 'T00:00:00').toLocaleDateString('pt-BR');
                document.getElementById('confirmTime').textContent = appointmentData.time;
                document.getElementById('confirmPrice').textContent = `R$ ${appointmentData.price.toFixed(2)}`;
                
                document.getElementById('confirmModal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Erro ao salvar agendamento:', error);
                alert('Erro ao confirmar agendamento. Tente novamente.');
            }
        }

        function closeModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            location.reload();
        }

        // Máscara para telefone
        document.getElementById('clientPhone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/^(\d{2})(\d)/g, '$1 $2');
                value = value.replace(/(\d)(\d{4})$/, '$1-$2');
            }
            e.target.value = value;
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97971e6fa6324d42',t:'MTc1NjkyMjEzNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
